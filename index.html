<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shake Player — Full</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <meta property="og:title" content="Shake Player online tool">
  <meta property="og:description" content="Play MP4 / MKV / HLS / M3U8 / MPD with ClearKey support via Shaka Player UI">
  <link rel="shortcut icon" type="image/x-icon" href="logo.png">

  <!-- Shaka Player -->
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.13.3/dist/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.13.3/dist/controls.min.css">

  <style>
    :root{
      --bg:#000;
      --accent:#ff006e;
      --panel:#111214;
      --btn-text:#ffffff;
    }

    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;overflow:hidden;}

    /* Container */
    .shaka-video-container{position:relative;width:100vw;height:100vh;background:#000;display:flex;align-items:center;justify-content:center;}
    video.shaka-video{width:100%;height:100%;object-fit:cover;background:#000;display:block;}

    /* Right controls column (vertical on desktop) */
    #controls{
      position:fixed;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:1200;
      pointer-events:auto;
    }

    .control-button{
      display:flex;
      align-items:center;
      justify-content:center;
      width:56px;
      height:56px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background:linear-gradient(145deg,#073f6c,#1473be);
      color:var(--btn-text);
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
      transition:transform .12s ease,opacity .12s ease;
      padding:6px;
    }
    .control-button:active{transform:translateY(2px);}

    .stream-button{background:linear-gradient(145deg,#33001b,#ff0084);}
    .mute-button{background:linear-gradient(145deg,#3494e6,#ec6ead);}
    .action-button{background:linear-gradient(145deg,#ee0979,#ff6a00);}
    .pip-button{background:linear-gradient(145deg,#3a1c71,#d76d77);}
    .fullscreen-button{background:linear-gradient(145deg,#43c6ac,#191654);}

    /* Small header text (optional) */
    .title {
      position:fixed;
      left:14px;
      top:10px;
      z-index:1200;
      font-weight:700;
      letter-spacing:0.4px;
      color:#fff;
      background:linear-gradient(90deg,rgba(255,255,255,0.06),transparent);
      padding:6px 10px;border-radius:8px;
      font-size:14px;
    }

    /* Make UI overlay controls visible over video */
    .shaka-video-container .shaka-overlay-container { z-index:1000; }

    /* Responsive: controls row at bottom for narrow screens */
    @media (max-width:900px), (max-aspect-ratio: 1/1) {
      #controls{
        right:50%;
        transform:translate(50%,0);
        bottom:12px;
        top:auto;
        left:50%;
        flex-direction:row;
        gap:8px;
      }
      .control-button{width:48px;height:48px;}
    }

    /* Tiny helper for visually-hidden text (accessibility) */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body>
  <div class="title">Shake Player</div>

  <!-- Shaka player container -->
  <div data-shaka-player-container class="shaka-video-container" id="player-container">
    <video autoplay muted playsinline data-shaka-player id="video" class="shaka-video" poster="https://i.gifer.com/ZKZg.gif"></video>
  </div>

  <!-- Custom controls -->
  <div id="controls" aria-hidden="false">
    <button class="control-button fullscreen-button" title="Toggle Page Fullscreen" onclick="toggleFullScreen()">
      <!-- fullscreen icon -->
      <svg xmlns="http://www.w3.org/2000/svg" height="22" viewBox="0 -960 960 960" width="22" fill="#fff"><path d="M120-120v-240h80v160h160v80H120Zm480 0v-80h160v-160h80v240H600ZM120-600v-240h240v80H200v160h-80Zm680 0v-160H640v-80h240v240h-80Z"/></svg>
    </button>

    <button class="control-button fullscreen-button" title="Toggle Fullscreen (Landscape)" onclick="toggleFullScreenLandscape()">
      <svg xmlns="http://www.w3.org/2000/svg" height="22" viewBox="0 -960 960 960" width="22" fill="#fff"><path d="M136.62-210q-38.35 0-64.48-26.14Q46-262.27 46-300.62v-358.76q0-38.35 26.14-64.48Q98.27-750 136.62-750h686.76q38.35 0 64.48 26.14Q914-697.73 914-659.38v358.76q0 38.35-26.14 64.48Q861.73-210 823.38-210H136.62Z"/></svg>
    </button>

    <button class="control-button stream-button" id="streamToggle" title="Play / Pause" onclick="toggleStream()">
      <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="#fff"><path d="M332-234.31v-491.38L720.15-480 332-234.31Z"/></svg>
      <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="#fff" style="display:none"><path d="M210-760h210v540H210V-760Zm330 0h210v540H540V-760Z"/></svg>
    </button>

    <button class="control-button fullscreen-button" title="Toggle Video Fullscreen" onclick="toggleFullScreenVideo()">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="#fff"><path d="M120-120v-240h80v160h160v80H120Zm480 0v-80h160v-160h80v240H600Z"/></svg>
    </button>

    <button class="control-button action-button" title="Reload Stream" onclick="reloadStream()">
      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff"><path d="M480-80q-72.54 0-136.71-27.64-64.16-27.64-112.09-75.56-47.92-47.93-75.56-112.09Q128-359.46 128-432h66q0 119 83.5 202.5T480-146q119 0 202.5-83.5T766-432q0-119-83.5-202.5T480-718h-9.23l63.08 63.08-46.31 48.77-143.85-144.62 145.39-144.62 46.3 46.77L470.77-784H480q72.54 0 136.71 27.64 64.16 27.64 112.09 75.56 47.92 47.93 75.56 112.09Q832-504.54 832-432t-27.64 136.71q-27.64 64.16-75.56 112.09-47.93 47.92-112.09 75.56Q552.54-80 480-80Z"/></svg>
    </button>

    <button class="control-button action-button" title="Seek -5s" onclick="seekBackward()">
      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff"><path d="M382-312.31H520q14.77 0 26.23 10.26t11.46 25.43V-348q0 15.17-11.46 25.43T520-312.31H382.31Z"/></svg>
    </button>

    <button class="control-button action-button" title="Seek +5s" onclick="seekForward()">
      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff"><path d="M382.31-312.31H520q14.77 0 26.23 10.26t11.46 25.43V-348q0 15.17-11.46 25.43T520-312.31H382.31Z"/></svg>
    </button>

    <button class="control-button mute-button" id="muteBtn" title="Mute / Unmute" onclick="toggleMute()">
      <svg class="unmute-icon" xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff" style="display:none"><path d="M547.08-106.23v-68q103.07-29.08 167.84-115 64.77-85.92 64.77-192.77 0-105.85-65.27-190.77-65.27-84.92-167.34-114v-68q130.38 29.85 214.5 134.35 84.11 104.5 84.11 238.42 0 134.92-84.11 240.42-84.12 105.5-214.5 135.35Z"/></svg>
      <svg class="mute-icon" xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff"><path d="M200-320v-320h160l240-240v800L360-320H200Z"/></svg>
    </button>

    <button class="control-button action-button" title="Stop & Unload" onclick="endStream()">
      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff"><path d="M252-203.69 205.69-252l227-228-227-230L252-758.31l229 230 227-230L754.31-710l-227 230 227 228L708-203.69l-227-230-229 230Z"/></svg>
    </button>

    <button class="control-button pip-button" title="Picture in Picture" onclick="togglePiP()">
      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#fff"><path d="M569.15-170v-159.85H873V-170H569.15Z"/></svg>
    </button>
  </div>

  <script>
    // ---- Stream info (user-provided) ----
    const channelstreamInfo = {
      // default stream (from user message)
      streamUrl: "https://jiotvpllive.cdn.jio.com/bpk-tv/Surya_Music_MOB/WDVLive/index.mpd?__hdnea__=st=1763032096~exp=1763118496~acl=/*~hmac=0ea437341a7185d02af98041febcfd963c5033ad914f3740cce76d333c4a75c3&xxx=",

      // ClearKey mapping (keyid -> key). Provide if needed for DASH/CENC content.
      clearKeys: {
        // both formats supported; the original example contained a clear key entry — keep it
        "1779c27b9d077a3ba0c9cc1bb9a94b9f": "cc5cf3b7928fb9e0a1ee6a8b566f0a8e",
        // you also included a vercel endpoint in the m3u snippet; if you need that, set authBearer or do custom networking
      },

      // optional bearer token to add to requests
      authBearer: "",

      // poster shown while loading
      streamPoster: "https://i.gifer.com/ZKZg.gif"
    };

    // ---- Global vars ----
    let player = null;
    let ui = null;
    const video = document.getElementById('video');
    const container = document.getElementById('player-container');

    // persist rate/muted on reloads (simple)
    let previousSettings = { playbackRate: 1, muted: true };

    // helper: detect mobile
    function isMobile() {
      return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
    }

    // Initialize Shaka player + UI
    async function initializePlayer() {
      try {
        // set poster + default settings
        video.poster = channelstreamInfo.streamPoster || "";
        video.muted = previousSettings.muted;
        video.playbackRate = previousSettings.playbackRate;
        video.autoplay = true;
        video.playsInline = true;

        // Destroy previous if exists
        if (player) {
          try { await ui?.destroy(); } catch(e){}
          try { await player.destroy(); } catch(e){}
          ui = null; player = null;
        }

        // create player and attach
        player = new shaka.Player(video);

        // configure network filters for auth bearer header (if any)
        const networkingEngine = player.getNetworkingEngine();
        networkingEngine.clearAllRequestFilters();
        networkingEngine.registerRequestFilter((type, request) => {
          if (channelstreamInfo.authBearer) {
            request.headers = request.headers || {};
            request.headers.Authorization = `Bearer ${channelstreamInfo.authBearer}`;
          }
        });

        // configure UI overlay
        ui = new shaka.ui.Overlay(player, container, video);

        // config options
        const uiConfig = {
          trackLabelFormat: shaka.ui.Overlay.TrackLabelFormat.LANGUAGE,
          fadeDelay: 0,
          doubleClickForFullscreen: false,
          singleClickForPlayAndPause: false,
          enableKeyboardPlaybackControls: true,
          enableFullscreenOnRotation: false,
          forceLandscapeOnFullscreen: false,
          enableTooltips: false,
          addSeekBar: true,
          addBigPlayButton: true,
          controlPanelElements: [
            "time_and_duration","mute","volume","rewind","fast_forward",
            "play_pause","spacer","playback_rate","quality","picture_in_picture","fullscreen","overflow_menu"
          ],
          overflowMenuButtons: ["quality","picture_in_picture","airplay","cast","statistics","language","playback_rate","captions","save_video_frame","loop"],
          playbackRates: [.5,.75,1,1.05,1.1,1.25,1.5,1.75,2],
          keyboardSeekDistance: 5,
        };

        if (isMobile()) {
          // simplify some controls for mobile
          uiConfig.addBigPlayButton = true;
          uiConfig.controlPanelElements = uiConfig.controlPanelElements.filter(e => e !== "volume");
        }

        ui.configure(uiConfig);

        // configure player streaming/abr/drm
        player.configure({
          abr: {
            enabled: true,
            bandwidthUpgradeTarget: 1.2
          },
          streaming: {
            bufferingGoal: 30,
            rebufferingGoal: 1,
            lowLatencyMode: true
          },
          drm: {
            // ClearKeys if provided
            clearKeys: channelstreamInfo.clearKeys || {}
          }
        });

        // attach handlers for custom +/-5 buttons: make sure the UI created rewind/fast-forward buttons work
        await player.attach(video);
        // load the stream
        console.log("Loading stream:", channelstreamInfo.streamUrl);
        await player.load(channelstreamInfo.streamUrl);
        console.log("Stream loaded successfully.");

      } catch (err) {
        console.error("initializePlayer error:", err);
        // show overlay message on failure (basic)
        alert("Error loading stream: " + (err && err.message ? err.message : err));
      }
    }

    // DOM events: keep play/pause icon toggled
    const streamButton = document.getElementById('streamToggle');
    const playIcon = streamButton.querySelector('.play-icon');
    const pauseIcon = streamButton.querySelector('.pause-icon');

    video.addEventListener('play', () => {
      playIcon.style.display = 'none';
      pauseIcon.style.display = '';
    });
    video.addEventListener('pause', () => {
      playIcon.style.display = '';
      pauseIcon.style.display = 'none';
    });

    // basic control functions
    function toggleStream() {
      if (!video) return;
      if (video.paused) {
        video.play().catch(e => console.warn('Play blocked:', e));
      } else {
        video.pause();
      }
    }

    function seekBackward() {
      if (!video) return;
      video.currentTime = Math.max(0, (video.currentTime || 0) - 5);
    }

    function seekForward() {
      if (!video) return;
      if (video.duration && !isNaN(video.duration))
        video.currentTime = Math.min(video.duration, (video.currentTime || 0) + 5);
      else
        video.currentTime = (video.currentTime || 0) + 5;
    }

    function toggleMute() {
      if (!video) return;
      video.muted = !video.muted;
    }

    // update mute icons
    const muteBtn = document.getElementById('muteBtn');
    function updateMuteIcons() {
      const muteIcon = muteBtn.querySelector('.mute-icon');
      const unmuteIcon = muteBtn.querySelector('.unmute-icon');
      if (video.muted) {
        muteIcon.style.display = 'none';
        if (unmuteIcon) unmuteIcon.style.display = '';
      } else {
        muteIcon.style.display = '';
        if (unmuteIcon) unmuteIcon.style.display = 'none';
      }
    }
    video.addEventListener('volumechange', updateMuteIcons);
    // set initial state
    updateMuteIcons();

    // reload stream (destroy + reinit)
    let reloadTimeout = null;
    async function reloadStream() {
      console.log("Reload requested...");
      if (reloadTimeout) {
        clearTimeout(reloadTimeout);
        reloadTimeout = null;
      }
      // graceful destroy
      try { await ui?.destroy(); } catch(e) {}
      try { await player?.destroy(); } catch(e) {}
      ui = null; player = null;

      // small debounce
      reloadTimeout = setTimeout(async () => {
        await initializePlayer();
        reloadTimeout = null;
      }, 300);
    }

    // stop/unload stream
    async function endStream() {
      try {
        if (player) {
          await player.unload();
          await player.destroy();
        }
        ui = null; player = null;
        video.pause();
        video.removeAttribute('src');
        video.load();
        console.log('Stream ended and unloaded.');
      } catch (e) {
        console.error('Error ending stream:', e);
      }
    }

    // Fullscreen helpers
    function toggleFullScreen() {
      if (document.fullscreenElement) {
        document.exitFullscreen?.();
      } else {
        document.documentElement.requestFullscreen?.().catch(e => console.warn('Fullscreen failed:', e));
      }
    }

    function toggleFullScreenLandscape() {
      if (document.fullscreenElement) {
        document.exitFullscreen?.();
      } else {
        document.documentElement.requestFullscreen?.()
          .then(() => { try { screen.orientation?.lock('landscape').catch(()=>{}); } catch(e){} })
          .catch(e => console.warn('Fullscreen request failed:', e));
      }
    }

    function toggleFullScreenVideo() {
      // use Shaka's fullscreen button if available, otherwise fallback to element requestFullscreen
      const shakaFsBtn = document.querySelector('.shaka-fullscreen-button');
      if (shakaFsBtn) shakaFsBtn.click();
      else {
        if (!document.fullscreenElement) {
          video.requestFullscreen?.();
        } else {
          document.exitFullscreen?.();
        }
      }
    }

    // Picture in Picture
    async function togglePiP() {
      try {
        if (!document.pictureInPictureEnabled) {
          console.warn('PiP not supported.');
          return;
        }
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
        } else {
          // some browsers require the video to be playing
          if (video.paused) {
            try { await video.play(); } catch(e){}
          }
          await video.requestPictureInPicture();
        }
      } catch (e) {
        console.warn('PiP error:', e);
      }
    }

    // keyboard shortcuts
    document.addEventListener('keydown', (ev) => {
      const key = ev.key;
      if (!video) return;
      switch (key) {
        case ' ':
          ev.preventDefault();
          toggleStream();
          break;
        case 'ArrowUp':
          ev.preventDefault();
          video.volume = Math.min(1, (video.volume || 0) + 0.1);
          break;
        case 'ArrowDown':
          ev.preventDefault();
          video.volume = Math.max(0, (video.volume || 0) - 0.1);
          break;
        case 'ArrowLeft':
          ev.preventDefault();
          seekBackward();
          break;
        case 'ArrowRight':
          ev.preventDefault();
          seekForward();
          break;
        case 'f':
          toggleFullScreenLandscape();
          break;
        case 'm':
          toggleMute();
          break;
        case 'p':
          togglePiP();
          break;
      }
    });

    // Auto init on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      initializePlayer().catch(e => console.error('init error:', e));
      // small handler for mobile address bar hiding
      setTimeout(()=>{ window.scrollTo(0,1); }, 100);
    });

    // expose functions for debugging from console (optional)
    window.shakaPlayer = {
      initializePlayer,
      reloadStream,
      endStream,
      toggleStream,
      seekForward,
      seekBackward,
      toggleMute,
      togglePiP,
      toggleFullScreen,
      toggleFullScreenLandscape,
      toggleFullScreenVideo
    };
  </script>
</body>
  </html>
